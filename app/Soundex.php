<?php
/**
 * webtrees: online genealogy
 * Copyright (C) 2017 webtrees development team
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
namespace Fisharebest\Webtrees;

/**
 * Phonetic matching of strings.
 */
class Soundex {
	/**
	 * Which algorithms are supported.
	 *
	 * @return string[]
	 */
	public static function getAlgorithms() {
		return [
			'std' => /* I18N: http://en.wikipedia.org/wiki/Soundex */ I18N::translate('Russell'),
			'dm'  => /* I18N: http://en.wikipedia.org/wiki/Daitchâ€“Mokotoff_Soundex */ I18N::translate('Daitch-Mokotoff'),
		];
	}

	/**
	 * Is there a match between two soundex codes?
	 *
	 * @param string $soundex1
	 * @param string $soundex2
	 *
	 * @return bool
	 */
	public static function compare($soundex1, $soundex2) {
		if ($soundex1 && $soundex2) {
			foreach (explode(':', $soundex1) as $code) {
				if (strpos($soundex2, $code) !== false) {
					return true;
				}
			}
		}

		return false;
	}

	/**
	 * Generate Russell soundex codes for a given text.
	 *
	 * @param $text
	 *
	 * @return null|string
	 */
	public static function russell($text) {
		$words         = preg_split('/\s/', $text, -1, PREG_SPLIT_NO_EMPTY);
		$soundex_array = [];
		foreach ($words as $word) {
			$soundex = soundex($word);
			// Only return codes from recognisable sounds
			if ($soundex !== '0000') {
				$soundex_array[] = $soundex;
			}
		}
		// Combine words, e.g. â€œNew Yorkâ€ as â€œNewyorkâ€
		if (count($words) > 1) {
			$soundex_array[] = soundex(strtr($text, ' ', ''));
		}
		// A varchar(255) column can only hold 51 4-character codes (plus 50 delimiters)
		$soundex_array = array_slice(array_unique($soundex_array), 0, 51);

		if ($soundex_array) {
			return implode(':', $soundex_array);
		} else {
			return '';
		}
	}

	/**
	 * Generate Daitchâ€“Mokotoff soundex codes for a given text.
	 *
	 * @param $text
	 *
	 * @return null|string
	 */
	public static function daitchMokotoff($text) {
		$words         = preg_split('/\s/', $text, -1, PREG_SPLIT_NO_EMPTY);
		$soundex_array = [];
		foreach ($words as $word) {
			$soundex_array = array_merge($soundex_array, self::daitchMokotoffWord($word));
		}
		// Combine words, e.g. â€œNew Yorkâ€ as â€œNewyorkâ€
		if (count($words) > 1) {
			$soundex_array = array_merge($soundex_array, self::daitchMokotoffWord(strtr($text, ' ', '')));
		}
		// A varchar(255) column can only hold 36 6-character codes (plus 35 delimiters)
		$soundex_array = array_slice(array_unique($soundex_array), 0, 36);

		if ($soundex_array) {
			return implode(':', $soundex_array);
		} else {
			return '';
		}
	}

	// Determine the Daitchâ€“Mokotoff Soundex code for a word
	// Original implementation by Gerry Kroll, and analysis by Meliza Amity

	// Max. table key length (in ASCII bytes -- NOT in UTF-8 characters!)
	const MAXCHAR = 7;

	/**
	 * Name transformation arrays.
	 * Used to transform the Name string to simplify the "sounds like" table.
	 * This is especially useful in Hebrew.
	 *
	 * Each array entry defines the "from" and "to" arguments of an preg($from, $to, $text)
	 * function call to achieve the desired transformations.
	 *
	 * Note about the use of "\x01":
	 * This code, which canâ€™t legitimately occur in the kind of text we're dealing with,
	 * is used as a place-holder so that conditional string replacements can be done.
	 *
	 * @var string[][]
	 */
	private static $transformNameTable = [
		// Force Yiddish ligatures to be treated as separate letters
		['×°', '×•×•'],
		['×²', '×™×™'],
		['×±', '×•×™'],
		['×‘×•', '×‘×¢'],
		['×¤×•', '×¤×¢'],
		['×•×ž', '×¢×ž'],
		['×•×', '×¢×'],
		['×•× ', '×¢× '],
		['×•×Ÿ', '×¢×Ÿ'],
		['×•×•', '×‘'],
		["\x01", ''],
		['×™×™×”$', "\x01×”"],
		['×™×™×¢$', "\x01×¢"],
		['×™×™', '×¢'],
		["\x01", '×™×™'],
	];

	/**
	 * The DM sound coding table is organized this way:
	 * key: a variable-length string that corresponds to the UTF-8 character sequence
	 * represented by the table entry. Currently, that string can be up to 7
	 * bytes long. This maximum length is defined by the value of global variable
	 * $maxchar.
	 *
	 * value: an array as follows:
	 * [0]:  zero if not a vowel
	 * [1]:  sound value when this string is at the beginning of the word
	 * [2]:  sound value when this string is followed by a vowel
	 * [3]:  sound value for other cases
	 * [1],[2],[3] can be repeated several times to create branches in the code
	 * an empty sound value means "ignore in this state"
	 *
	 * @var string[][]
	 */
	private static $dmsounds = [
		'A'       => ['1', '0', '', ''],
		'Ã€'       => ['1', '0', '', ''],
		'Ã'       => ['1', '0', '', ''],
		'Ã‚'       => ['1', '0', '', ''],
		'Ãƒ'       => ['1', '0', '', ''],
		'Ã„'       => ['1', '0', '1', '', '0', '', ''],
		'Ã…'       => ['1', '0', '', ''],
		'Ä‚'       => ['1', '0', '', ''],
		'Ä„'       => ['1', '', '', '', '', '', '6'],
		'áº  '      => ['1', '0', '', ''],
		'áº¢ '      => ['1', '0', '', ''],
		'áº¤ '      => ['1', '0', '', ''],
		'áº¦ '      => ['1', '0', '', ''],
		'áº¨ '      => ['1', '0', '', ''],
		'áºª '      => ['1', '0', '', ''],
		'áº¬ '      => ['1', '0', '', ''],
		'áº® '      => ['1', '0', '', ''],
		'áº° '      => ['1', '0', '', ''],
		'áº² '      => ['1', '0', '', ''],
		'áº´ '      => ['1', '0', '', ''],
		'áº¶ '      => ['1', '0', '', ''],
		'AE'      => ['1', '0', '1', ''],
		'Ã†'       => ['1', '0', '1', ''],
		'AI'      => ['1', '0', '1', ''],
		'AJ'      => ['1', '0', '1', ''],
		'AU'      => ['1', '0', '7', ''],
		'AV'      => ['1', '0', '7', '', '7', '7', '7'],
		'Ã„U'      => ['1', '0', '1', ''],
		'AY'      => ['1', '0', '1', ''],
		'B'       => ['0', '7', '7', '7'],
		'C'       => ['0', '5', '5', '5', '34', '4', '4'],
		'Ä†'       => ['0', '4', '4', '4'],
		'ÄŒ'       => ['0', '4', '4', '4'],
		'Ã‡'       => ['0', '4', '4', '4'],
		'CH'      => ['0', '5', '5', '5', '34', '4', '4'],
		'CHS'     => ['0', '5', '54', '54'],
		'CK'      => ['0', '5', '5', '5', '45', '45', '45'],
		'CCS'     => ['0', '4', '4', '4'],
		'CS'      => ['0', '4', '4', '4'],
		'CSZ'     => ['0', '4', '4', '4'],
		'CZ'      => ['0', '4', '4', '4'],
		'CZS'     => ['0', '4', '4', '4'],
		'D'       => ['0', '3', '3', '3'],
		'ÄŽ'       => ['0', '3', '3', '3'],
		'Ä'       => ['0', '3', '3', '3'],
		'DRS'     => ['0', '4', '4', '4'],
		'DRZ'     => ['0', '4', '4', '4'],
		'DS'      => ['0', '4', '4', '4'],
		'DSH'     => ['0', '4', '4', '4'],
		'DSZ'     => ['0', '4', '4', '4'],
		'DT'      => ['0', '3', '3', '3'],
		'DDZ'     => ['0', '4', '4', '4'],
		'DDZS'    => ['0', '4', '4', '4'],
		'DZ'      => ['0', '4', '4', '4'],
		'DÅ¹'      => ['0', '4', '4', '4'],
		'DÅ»'      => ['0', '4', '4', '4'],
		'DZH'     => ['0', '4', '4', '4'],
		'DZS'     => ['0', '4', '4', '4'],
		'E'       => ['1', '0', '', ''],
		'Ãˆ'       => ['1', '0', '', ''],
		'Ã‰'       => ['1', '0', '', ''],
		'ÃŠ'       => ['1', '0', '', ''],
		'Ã‹'       => ['1', '0', '', ''],
		'Ä”'       => ['1', '0', '', ''],
		'Ä–'       => ['1', '0', '', ''],
		'Ä˜'       => ['1', '', '', '6', '', '', ''],
		'áº¸ '      => ['1', '0', '', ''],
		'áºº '      => ['1', '0', '', ''],
		'áº¼ '      => ['1', '0', '', ''],
		'áº¾ '      => ['1', '0', '', ''],
		'á»€ '      => ['1', '0', '', ''],
		'á»‚ '      => ['1', '0', '', ''],
		'á»„ '      => ['1', '0', '', ''],
		'á»† '      => ['1', '0', '', ''],
		'EAU'     => ['1', '0', '', ''],
		'EI'      => ['1', '0', '1', ''],
		'EJ'      => ['1', '0', '1', ''],
		'EU'      => ['1', '1', '1', ''],
		'EY'      => ['1', '0', '1', ''],
		'F'       => ['0', '7', '7', '7'],
		'FB'      => ['0', '7', '7', '7'],
		'G'       => ['0', '5', '5', '5', '34', '4', '4'],
		'Äž'       => ['0', '', '', ''],
		'GGY'     => ['0', '5', '5', '5'],
		'GY'      => ['0', '5', '5', '5'],
		'H'       => ['0', '5', '5', '', '5', '5', '5'],
		'I'       => ['1', '0', '', ''],
		'ÃŒ'       => ['1', '0', '', ''],
		'Ã'       => ['1', '0', '', ''],
		'ÃŽ'       => ['1', '0', '', ''],
		'Ã'       => ['1', '0', '', ''],
		'Ä¨'       => ['1', '0', '', ''],
		'Ä®'       => ['1', '0', '', ''],
		'Ä°'       => ['1', '0', '', ''],
		'á»ˆ '      => ['1', '0', '', ''],
		'á»Š '      => ['1', '0', '', ''],
		'IA'      => ['1', '1', '', ''],
		'IE'      => ['1', '1', '', ''],
		'IO'      => ['1', '1', '', ''],
		'IU'      => ['1', '1', '', ''],
		'J'       => ['0', '1', '', '', '4', '4', '4', '5', '5', ''],
		'K'       => ['0', '5', '5', '5'],
		'KH'      => ['0', '5', '5', '5'],
		'KS'      => ['0', '5', '54', '54'],
		'L'       => ['0', '8', '8', '8'],
		'Ä½'       => ['0', '8', '8', '8'],
		'Ä¹'       => ['0', '8', '8', '8'],
		'Å'       => ['0', '7', '7', '7', '8', '8', '8'],
		'LL'      => ['0', '8', '8', '8', '58', '8', '8', '1', '8', '8'],
		'LLY'     => ['0', '8', '8', '8', '1', '8', '8'],
		'LY'      => ['0', '8', '8', '8', '1', '8', '8'],
		'M'       => ['0', '6', '6', '6'],
		'MÄ”'      => ['0', '66', '66', '66'],
		'MN'      => ['0', '66', '66', '66'],
		'N'       => ['0', '6', '6', '6'],
		'Åƒ'       => ['0', '6', '6', '6'],
		'Å‡'       => ['0', '6', '6', '6'],
		'Ã‘'       => ['0', '6', '6', '6'],
		'NM'      => ['0', '66', '66', '66'],
		'O'       => ['1', '0', '', ''],
		'Ã’'       => ['1', '0', '', ''],
		'Ã“'       => ['1', '0', '', ''],
		'Ã”'       => ['1', '0', '', ''],
		'Ã•'       => ['1', '0', '', ''],
		'Ã–'       => ['1', '0', '', ''],
		'Ã˜'       => ['1', '0', '', ''],
		'Å'       => ['1', '0', '', ''],
		'Å’'       => ['1', '0', '', ''],
		'Æ '       => ['1', '0', '', ''],
		'á»Œ '      => ['1', '0', '', ''],
		'á»Ž '      => ['1', '0', '', ''],
		'á» '      => ['1', '0', '', ''],
		'á»’ '      => ['1', '0', '', ''],
		'á»” '      => ['1', '0', '', ''],
		'á»– '      => ['1', '0', '', ''],
		'á»˜ '      => ['1', '0', '', ''],
		'á»š '      => ['1', '0', '', ''],
		'á»œ '      => ['1', '0', '', ''],
		'á»ž '      => ['1', '0', '', ''],
		'á»  '      => ['1', '0', '', ''],
		'á»¢ '      => ['1', '0', '', ''],
		'OE'      => ['1', '0', '', ''],
		'OI'      => ['1', '0', '1', ''],
		'OJ'      => ['1', '0', '1', ''],
		'OU'      => ['1', '0', '', ''],
		'OY'      => ['1', '0', '1', ''],
		'P'       => ['0', '7', '7', '7'],
		'PF'      => ['0', '7', '7', '7'],
		'PH'      => ['0', '7', '7', '7'],
		'Q'       => ['0', '5', '5', '5'],
		'R'       => ['0', '9', '9', '9'],
		'Å˜'       => ['0', '4', '4', '4'],
		'RS'      => ['0', '4', '4', '4', '94', '94', '94'],
		'RZ'      => ['0', '4', '4', '4', '94', '94', '94'],
		'S'       => ['0', '4', '4', '4'],
		'Åš'       => ['0', '4', '4', '4'],
		'Å '       => ['0', '4', '4', '4'],
		'Åž'       => ['0', '4', '4', '4'],
		'SC'      => ['0', '2', '4', '4'],
		'Å ÄŒ '     => ['0', '2', '4', '4'],
		'SCH'     => ['0', '4', '4', '4'],
		'SCHD'    => ['0', '2', '43', '43'],
		'SCHT'    => ['0', '2', '43', '43'],
		'SCHTCH'  => ['0', '2', '4', '4'],
		'SCHTSCH' => ['0', '2', '4', '4'],
		'SCHTSH'  => ['0', '2', '4', '4'],
		'SD'      => ['0', '2', '43', '43'],
		'SH'      => ['0', '4', '4', '4'],
		'SHCH'    => ['0', '2', '4', '4'],
		'SHD'     => ['0', '2', '43', '43'],
		'SHT'     => ['0', '2', '43', '43'],
		'SHTCH'   => ['0', '2', '4', '4'],
		'SHTSH'   => ['0', '2', '4', '4'],
		'ÃŸ'       => ['0', '', '4', '4'],
		'ST'      => ['0', '2', '43', '43'],
		'STCH'    => ['0', '2', '4', '4'],
		'STRS'    => ['0', '2', '4', '4'],
		'STRZ'    => ['0', '2', '4', '4'],
		'STSCH'   => ['0', '2', '4', '4'],
		'STSH'    => ['0', '2', '4', '4'],
		'SSZ'     => ['0', '4', '4', '4'],
		'SZ'      => ['0', '4', '4', '4'],
		'SZCS'    => ['0', '2', '4', '4'],
		'SZCZ'    => ['0', '2', '4', '4'],
		'SZD'     => ['0', '2', '43', '43'],
		'SZT'     => ['0', '2', '43', '43'],
		'T'       => ['0', '3', '3', '3'],
		'Å¤'       => ['0', '3', '3', '3'],
		'Å¢'       => ['0', '3', '3', '3', '4', '4', '4'],
		'TC'      => ['0', '4', '4', '4'],
		'TCH'     => ['0', '4', '4', '4'],
		'TH'      => ['0', '3', '3', '3'],
		'TRS'     => ['0', '4', '4', '4'],
		'TRZ'     => ['0', '4', '4', '4'],
		'TS'      => ['0', '4', '4', '4'],
		'TSCH'    => ['0', '4', '4', '4'],
		'TSH'     => ['0', '4', '4', '4'],
		'TSZ'     => ['0', '4', '4', '4'],
		'TTCH'    => ['0', '4', '4', '4'],
		'TTS'     => ['0', '4', '4', '4'],
		'TTSCH'   => ['0', '4', '4', '4'],
		'TTSZ'    => ['0', '4', '4', '4'],
		'TTZ'     => ['0', '4', '4', '4'],
		'TZ'      => ['0', '4', '4', '4'],
		'TZS'     => ['0', '4', '4', '4'],
		'U'       => ['1', '0', '', ''],
		'Ã™'       => ['1', '0', '', ''],
		'Ãš'       => ['1', '0', '', ''],
		'Ã›'       => ['1', '0', '', ''],
		'Ãœ'       => ['1', '0', '', ''],
		'Å¨'       => ['1', '0', '', ''],
		'Åª'       => ['1', '0', '', ''],
		'Å®'       => ['1', '0', '', ''],
		'Å°'       => ['1', '0', '', ''],
		'Å²'       => ['1', '0', '', ''],
		'Æ¯'       => ['1', '0', '', ''],
		'á»¤ '      => ['1', '0', '', ''],
		'á»¦ '      => ['1', '0', '', ''],
		'á»¨ '      => ['1', '0', '', ''],
		'á»ª '      => ['1', '0', '', ''],
		'á»¬ '      => ['1', '0', '', ''],
		'á»® '      => ['1', '0', '', ''],
		'á»° '      => ['1', '0', '', ''],
		'UE'      => ['1', '0', '', ''],
		'UI'      => ['1', '0', '1', ''],
		'UJ'      => ['1', '0', '1', ''],
		'UY'      => ['1', '0', '1', ''],
		'UW'      => ['1', '0', '1', '', '0', '7', '7'],
		'V'       => ['0', '7', '7', '7'],
		'W'       => ['0', '7', '7', '7'],
		'X'       => ['0', '5', '54', '54'],
		'Y'       => ['1', '1', '', ''],
		'Ã'       => ['1', '1', '', ''],
		'á»² '      => ['1', '1', '', ''],
		'á»´ '      => ['1', '1', '', ''],
		'á»¶ '      => ['1', '1', '', ''],
		'á»¸ '      => ['1', '1', '', ''],
		'Z'       => ['0', '4', '4', '4'],
		'Å¹'       => ['0', '4', '4', '4'],
		'Å»'       => ['0', '4', '4', '4'],
		'Å½'       => ['0', '4', '4', '4'],
		'ZD'      => ['0', '2', '43', '43'],
		'ZDZ'     => ['0', '2', '4', '4'],
		'ZDZH'    => ['0', '2', '4', '4'],
		'ZH'      => ['0', '4', '4', '4'],
		'ZHD'     => ['0', '2', '43', '43'],
		'ZHDZH'   => ['0', '2', '4', '4'],
		'ZS'      => ['0', '4', '4', '4'],
		'ZSCH'    => ['0', '4', '4', '4'],
		'ZSH'     => ['0', '4', '4', '4'],
		'ZZS'     => ['0', '4', '4', '4'],
		// Cyrillic alphabet
		'Ð'   => ['1', '0', '', ''],
		'Ð‘'   => ['0', '7', '7', '7'],
		'Ð’'   => ['0', '7', '7', '7'],
		'Ð“'   => ['0', '5', '5', '5'],
		'Ð”'   => ['0', '3', '3', '3'],
		'Ð”Ð— ' => ['0', '4', '4', '4'],
		'Ð•'   => ['1', '0', '', ''],
		'Ð'   => ['1', '0', '', ''],
		'Ð–'   => ['0', '4', '4', '4'],
		'Ð—'   => ['0', '4', '4', '4'],
		'Ð˜'   => ['1', '0', '', ''],
		'Ð™'   => ['1', '1', '', '', '4', '4', '4'],
		'Ðš'   => ['0', '5', '5', '5'],
		'Ð›'   => ['0', '8', '8', '8'],
		'Ðœ'   => ['0', '6', '6', '6'],
		'Ð'   => ['0', '6', '6', '6'],
		'Ðž'   => ['1', '0', '', ''],
		'ÐŸ'   => ['0', '7', '7', '7'],
		'Ð '   => ['0', '9', '9', '9'],
		'Ð Ð– ' => ['0', '4', '4', '4'],
		'Ð¡'   => ['0', '4', '4', '4'],
		'Ð¢'   => ['0', '3', '3', '3'],
		'Ð£'   => ['1', '0', '', ''],
		'Ð¤'   => ['0', '7', '7', '7'],
		'Ð¥'   => ['0', '5', '5', '5'],
		'Ð¦'   => ['0', '4', '4', '4'],
		'Ð§'   => ['0', '4', '4', '4'],
		'Ð¨'   => ['0', '4', '4', '4'],
		'Ð©'   => ['0', '2', '4', '4'],
		'Ðª'   => ['0', '', '', ''],
		'Ð«'   => ['0', '1', '', ''],
		'Ð¬'   => ['0', '', '', ''],
		'Ð­'   => ['1', '0', '', ''],
		'Ð®'   => ['0', '1', '', ''],
		'Ð¯'   => ['0', '1', '', ''],
		// Greek alphabet
		'Î‘'   => ['1', '0', '', ''],
		'Î†'   => ['1', '0', '', ''],
		'Î‘Î™ ' => ['1', '0', '1', ''],
		'Î‘Î¥ ' => ['1', '0', '1', ''],
		'Î’'   => ['0', '7', '7', '7'],
		'Î“'   => ['0', '5', '5', '5'],
		'Î”'   => ['0', '3', '3', '3'],
		'Î•'   => ['1', '0', '', ''],
		'Îˆ'   => ['1', '0', '', ''],
		'Î•Î™ ' => ['1', '0', '1', ''],
		'Î•Î¥ ' => ['1', '1', '1', ''],
		'Î–'   => ['0', '4', '4', '4'],
		'Î—'   => ['1', '0', '', ''],
		'Î‰'   => ['1', '0', '', ''],
		'Î˜'   => ['0', '3', '3', '3'],
		'Î™'   => ['1', '0', '', ''],
		'ÎŠ'   => ['1', '0', '', ''],
		'Îª'   => ['1', '0', '', ''],
		'Î'   => ['1', '0', '', ''],
		'Îš'   => ['0', '5', '5', '5'],
		'Î›'   => ['0', '8', '8', '8'],
		'Îœ'   => ['0', '6', '6', '6'],
		'ÎœÎ  ' => ['0', '7', '7', '7'],
		'Î'   => ['0', '6', '6', '6'],
		'ÎÎ¤ ' => ['0', '3', '3', '3'],
		'Îž'   => ['0', '5', '54', '54'],
		'ÎŸ'   => ['1', '0', '', ''],
		'ÎŒ'   => ['1', '0', '', ''],
		'ÎŸÎ™ ' => ['1', '0', '1', ''],
		'ÎŸÎ¥ ' => ['1', '0', '1', ''],
		'Î '   => ['0', '7', '7', '7'],
		'Î¡'   => ['0', '9', '9', '9'],
		'Î£'   => ['0', '4', '4', '4'],
		'Ï‚'   => ['0', '', '', '4'],
		'Î¤'   => ['0', '3', '3', '3'],
		'Î¤Î– ' => ['0', '4', '4', '4'],
		'Î¤Î£ ' => ['0', '4', '4', '4'],
		'Î¥'   => ['1', '1', '', ''],
		'ÎŽ'   => ['1', '1', '', ''],
		'Î«'   => ['1', '1', '', ''],
		'Î°'   => ['1', '1', '', ''],
		'Î¥Îš ' => ['1', '5', '5', '5'],
		'Î¥Î¥ ' => ['1', '65', '65', '65'],
		'Î¦'   => ['0', '7', '7', '7'],
		'Î§'   => ['0', '5', '5', '5'],
		'Î¨'   => ['0', '7', '7', '7'],
		'Î©'   => ['1', '0', '', ''],
		'Î'   => ['1', '0', '', ''],
		// Hebrew alphabet
		'×'     => ['1', '0', '', ''],
		'××• '   => ['1', '0', '7', ''],
		'××’ '   => ['1', '4', '4', '4', '5', '5', '5', '34', '34', '34'],
		'×‘×‘ '   => ['0', '7', '7', '7', '77', '77', '77'],
		'×‘'     => ['0', '7', '7', '7'],
		'×’×’ '   => ['0', '4', '4', '4', '5', '5', '5', '45', '45', '45', '55', '55', '55', '54', '54', '54'],
		'×’×“ '   => ['0', '43', '43', '43', '53', '53', '53'],
		'×’×” '   => ['0', '45', '45', '45', '55', '55', '55'],
		'×’×– '   => ['0', '44', '44', '44', '45', '45', '45'],
		'×’×— '   => ['0', '45', '45', '45', '55', '55', '55'],
		'×’×› '   => ['0', '45', '45', '45', '55', '55', '55'],
		'×’×š '   => ['0', '45', '45', '45', '55', '55', '55'],
		'×’×¦ '   => ['0', '44', '44', '44', '45', '45', '45'],
		'×’×¥ '   => ['0', '44', '44', '44', '45', '45', '45'],
		'×’×§ '   => ['0', '45', '45', '45', '54', '54', '54'],
		'×’×© '   => ['0', '44', '44', '44', '54', '54', '54'],
		'×’×ª '   => ['0', '43', '43', '43', '53', '53', '53'],
		'×’'     => ['0', '4', '4', '4', '5', '5', '5'],
		'×“×– '   => ['0', '4', '4', '4'],
		'×“×“ '   => ['0', '3', '3', '3', '33', '33', '33'],
		'×“×˜ '   => ['0', '33', '33', '33'],
		'×“×© '   => ['0', '4', '4', '4'],
		'×“×¦ '   => ['0', '4', '4', '4'],
		'×“×¥ '   => ['0', '4', '4', '4'],
		'×“'     => ['0', '3', '3', '3'],
		'×”×’ '   => ['0', '54', '54', '54', '55', '55', '55'],
		'×”×› '   => ['0', '55', '55', '55'],
		'×”×— '   => ['0', '55', '55', '55'],
		'×”×§ '   => ['0', '55', '55', '55', '5', '5', '5'],
		'×”×” '   => ['0', '5', '5', '', '55', '55', ''],
		'×”'     => ['0', '5', '5', ''],
		'×•×™ '   => ['1', '', '', '', '7', '7', '7'],
		'×•'     => ['1', '7', '7', '7', '7', '', ''],
		'×•×• '   => ['1', '7', '7', '7', '7', '', ''],
		'×•×•× ¤' => ['1', '7', '7', '7', '77', '77', '77'],
		'×–×© '   => ['0', '4', '4', '4', '44', '44', '44'],
		'×–×“× –' => ['0', '2', '4', '4'],
		'×–'     => ['0', '4', '4', '4'],
		'×–×’ '   => ['0', '44', '44', '44', '45', '45', '45'],
		'×–×– '   => ['0', '4', '4', '4', '44', '44', '44'],
		'×–×¡ '   => ['0', '44', '44', '44'],
		'×–×¦ '   => ['0', '44', '44', '44'],
		'×–×¥ '   => ['0', '44', '44', '44'],
		'×—×’ '   => ['0', '54', '54', '54', '53', '53', '53'],
		'×—×— '   => ['0', '5', '5', '5', '55', '55', '55'],
		'×—×§ '   => ['0', '55', '55', '55', '5', '5', '5'],
		'×—×› '   => ['0', '45', '45', '45', '55', '55', '55'],
		'×—×¡ '   => ['0', '5', '54', '54'],
		'×—×© '   => ['0', '5', '54', '54'],
		'×—'     => ['0', '5', '5', '5'],
		'×˜×© '   => ['0', '4', '4', '4'],
		'×˜×“ '   => ['0', '33', '33', '33'],
		'×˜×™ '   => ['0', '3', '3', '3', '4', '4', '4', '3', '3', '34'],
		'×˜×ª '   => ['0', '33', '33', '33'],
		'×˜×˜ '   => ['0', '3', '3', '3', '33', '33', '33'],
		'×˜'     => ['0', '3', '3', '3'],
		'×™'     => ['1', '1', '', ''],
		'×™× '   => ['1', '1', '', '', '1', '1', '1'],
		'×›×’ '   => ['0', '55', '55', '55', '54', '54', '54'],
		'×›×© '   => ['0', '5', '54', '54'],
		'×›×¡ '   => ['0', '5', '54', '54'],
		'×›×› '   => ['0', '5', '5', '5', '55', '55', '55'],
		'×›×š '   => ['0', '5', '5', '5', '55', '55', '55'],
		'×›'     => ['0', '5', '5', '5'],
		'×›×— '   => ['0', '55', '55', '55', '5', '5', '5'],
		'×š'     => ['0', '', '5', '5'],
		'×œ'     => ['0', '8', '8', '8'],
		'×œ×œ '   => ['0', '88', '88', '88', '8', '8', '8'],
		'×ž×  '   => ['0', '66', '66', '66'],
		'×ž×Ÿ '   => ['0', '66', '66', '66'],
		'×ž×ž '   => ['0', '6', '6', '6', '66', '66', '66'],
		'×ž× '   => ['0', '6', '6', '6', '66', '66', '66'],
		'×ž'     => ['0', '6', '6', '6'],
		'×'     => ['0', '', '6', '6'],
		'× ×ž '   => ['0', '66', '66', '66'],
		'× × '   => ['0', '66', '66', '66'],
		'× ×  '   => ['0', '6', '6', '6', '66', '66', '66'],
		'× ×Ÿ '   => ['0', '6', '6', '6', '66', '66', '66'],
		'× '     => ['0', '6', '6', '6'],
		'×Ÿ'     => ['0', '', '6', '6'],
		'×¡×ª× ©' => ['0', '2', '4', '4'],
		'×¡×ª× –' => ['0', '2', '4', '4'],
		'×¡×˜× –' => ['0', '2', '4', '4'],
		'×¡×˜× ©' => ['0', '2', '4', '4'],
		'×¡×¦× “' => ['0', '2', '4', '4'],
		'×¡×˜ '   => ['0', '2', '4', '4', '43', '43', '43'],
		'×¡×ª '   => ['0', '2', '4', '4', '43', '43', '43'],
		'×¡×’ '   => ['0', '44', '44', '44', '4', '4', '4'],
		'×¡×¡ '   => ['0', '4', '4', '4', '44', '44', '44'],
		'×¡×¦ '   => ['0', '44', '44', '44'],
		'×¡×¥ '   => ['0', '44', '44', '44'],
		'×¡×– '   => ['0', '44', '44', '44'],
		'×¡×© '   => ['0', '44', '44', '44'],
		'×¡'     => ['0', '4', '4', '4'],
		'×¢'     => ['1', '0', '', ''],
		'×¤×‘ '   => ['0', '7', '7', '7', '77', '77', '77'],
		'×¤×•× •' => ['0', '7', '7', '7', '77', '77', '77'],
		'×¤×¤ '   => ['0', '7', '7', '7', '77', '77', '77'],
		'×¤×£ '   => ['0', '7', '7', '7', '77', '77', '77'],
		'×¤'     => ['0', '7', '7', '7'],
		'×£'     => ['0', '', '7', '7'],
		'×¦×’ '   => ['0', '44', '44', '44', '45', '45', '45'],
		'×¦×– '   => ['0', '44', '44', '44'],
		'×¦×¡ '   => ['0', '44', '44', '44'],
		'×¦×¦ '   => ['0', '4', '4', '4', '5', '5', '5', '44', '44', '44', '54', '54', '54', '45', '45', '45'],
		'×¦×¥ '   => ['0', '4', '4', '4', '5', '5', '5', '44', '44', '44', '54', '54', '54'],
		'×¦×© '   => ['0', '44', '44', '44', '4', '4', '4', '5', '5', '5'],
		'×¦'     => ['0', '4', '4', '4', '5', '5', '5'],
		'×¥'     => ['0', '', '4', '4'],
		'×§×” '   => ['0', '55', '55', '5'],
		'×§×¡ '   => ['0', '5', '54', '54'],
		'×§×© '   => ['0', '5', '54', '54'],
		'×§×§ '   => ['0', '5', '5', '5', '55', '55', '55'],
		'×§×— '   => ['0', '55', '55', '55'],
		'×§×› '   => ['0', '55', '55', '55'],
		'×§×š '   => ['0', '55', '55', '55'],
		'×§×’ '   => ['0', '55', '55', '55', '54', '54', '54'],
		'×§'     => ['0', '5', '5', '5'],
		'×¨×¨ '   => ['0', '99', '99', '99', '9', '9', '9'],
		'×¨'     => ['0', '9', '9', '9'],
		'×©×˜× –' => ['0', '2', '4', '4'],
		'×©×ª× ©' => ['0', '2', '4', '4'],
		'×©×ª× –' => ['0', '2', '4', '4'],
		'×©×˜× ©' => ['0', '2', '4', '4'],
		'×©×“ '   => ['0', '2', '43', '43'],
		'×©×– '   => ['0', '44', '44', '44'],
		'×©×¡ '   => ['0', '44', '44', '44'],
		'×©×ª '   => ['0', '2', '43', '43'],
		'×©×’ '   => ['0', '4', '4', '4', '44', '44', '44', '4', '43', '43'],
		'×©×˜ '   => ['0', '2', '43', '43', '44', '44', '44'],
		'×©×¦ '   => ['0', '44', '44', '44', '45', '45', '45'],
		'×©×¥ '   => ['0', '44', '', '44', '45', '', '45'],
		'×©×© '   => ['0', '4', '4', '4', '44', '44', '44'],
		'×©'     => ['0', '4', '4', '4'],
		'×ª×’ '   => ['0', '34', '34', '34'],
		'×ª×– '   => ['0', '34', '34', '34'],
		'×ª×© '   => ['0', '4', '4', '4'],
		'×ª×ª '   => ['0', '3', '3', '3', '4', '4', '4', '33', '33', '33', '44', '44', '44', '34', '34', '34', '43', '43', '43'],
		'×ª'     => ['0', '3', '3', '3', '4', '4', '4'],
		// Arabic alphabet
		'Ø§'   => ['1', '0', '', ''],
		'Ø¨'   => ['0', '7', '7', '7'],
		'Øª'   => ['0', '3', '3', '3'],
		'Ø«'   => ['0', '3', '3', '3'],
		'Ø¬'   => ['0', '4', '4', '4'],
		'Ø­'   => ['0', '5', '5', '5'],
		'Ø®'   => ['0', '5', '5', '5'],
		'Ø¯'   => ['0', '3', '3', '3'],
		'Ø°'   => ['0', '3', '3', '3'],
		'Ø±'   => ['0', '9', '9', '9'],
		'Ø²'   => ['0', '4', '4', '4'],
		'Ø³'   => ['0', '4', '4', '4'],
		'Ø´'   => ['0', '4', '4', '4'],
		'Øµ'   => ['0', '4', '4', '4'],
		'Ø¶'   => ['0', '3', '3', '3'],
		'Ø·'   => ['0', '3', '3', '3'],
		'Ø¸'   => ['0', '4', '4', '4'],
		'Ø¹'   => ['1', '0', '', ''],
		'Øº'   => ['0', '0', '', ''],
		'Ù'   => ['0', '7', '7', '7'],
		'Ù‚'   => ['0', '5', '5', '5'],
		'Ùƒ'   => ['0', '5', '5', '5'],
		'Ù„'   => ['0', '8', '8', '8'],
		'Ù„Ø§ ' => ['0', '8', '8', '8'],
		'Ù…'   => ['0', '6', '6', '6'],
		'Ù†'   => ['0', '6', '6', '6'],
		'Ù‡Ù† ' => ['0', '66', '66', '66'],
		'Ù‡'   => ['0', '5', '5', ''],
		'Ùˆ'   => ['1', '', '', '', '7', '', ''],
		'ÙŠ'   => ['0', '1', '', ''],
		'Ø¢'   => ['0', '1', '', ''],
		'Ø©'   => ['0', '', '', '3'],
		'ÛŒ'   => ['0', '1', '', ''],
		'Ù‰'   => ['1', '1', '', ''],
	];

	/**
	 * Calculate the Daitch-Mokotoff soundex for a word.
	 *
	 * @param string $name
	 *
	 * @return string[] List of possible DM codes for the word.
	 */
	private static function daitchMokotoffWord($name) {
		// Apply special transformation rules to the input string
		$name = I18N::strtoupper($name);
		foreach (self::$transformNameTable as $transformRule) {
			$name = str_replace($transformRule[0], $transformRule[1], $name);
		}

		// Initialize
		$name_script = I18N::textScript($name);
		$noVowels    = ($name_script == 'Hebr' || $name_script == 'Arab');

		$lastPos         = strlen($name) - 1;
		$currPos         = 0;
		$state           = 1; // 1: start of input string, 2: before vowel, 3: other
		$result          = []; // accumulate complete 6-digit D-M codes here
		$partialResult   = []; // accumulate incomplete D-M codes here
		$partialResult[] = ['!']; // initialize 1st partial result  ('!' stops "duplicate sound" check)

		// Loop through the input string.
		// Stop when the string is exhausted or when no more partial results remain
		while (count($partialResult) !== 0 && $currPos <= $lastPos) {
			// Find the DM coding table entry for the chunk at the current position
			$thisEntry = substr($name, $currPos, self::MAXCHAR); // Get maximum length chunk
			while ($thisEntry != '') {
				if (isset(self::$dmsounds[$thisEntry])) {
					break;
				}
				$thisEntry = substr($thisEntry, 0, -1); // Not in table: try a shorter chunk
			}
			if ($thisEntry === '') {
				$currPos++; // Not in table: advance pointer to next byte
				continue; // and try again
			}

			$soundTableEntry = self::$dmsounds[$thisEntry];
			$workingResult   = $partialResult;
			$partialResult   = [];
			$currPos += strlen($thisEntry);

			// Not at beginning of input string
			if ($state != 1) {
				if ($currPos <= $lastPos) {
					// Determine whether the next chunk is a vowel
					$nextEntry = substr($name, $currPos, self::MAXCHAR); // Get maximum length chunk
					while ($nextEntry != '') {
						if (isset(self::$dmsounds[$nextEntry])) {
							break;
						}
						$nextEntry = substr($nextEntry, 0, -1); // Not in table: try a shorter chunk
					}
				} else {
					$nextEntry = '';
				}
				if ($nextEntry != '' && self::$dmsounds[$nextEntry][0] != '0') {
					$state = 2;
				} else {
					// Next chunk is a vowel
					$state = 3;
				}
			}

			while ($state < count($soundTableEntry)) {
				// empty means 'ignore this sound in this state'
				if ($soundTableEntry[$state] == '') {
					foreach ($workingResult as $workingEntry) {
						$tempEntry = $workingEntry;
						$tempEntry[count($tempEntry) - 1] .= '!'; // Prevent false 'doubles'
						$partialResult[] = $tempEntry;
					}
				} else {
					foreach ($workingResult as $workingEntry) {
						if ($soundTableEntry[$state] !== $workingEntry[count($workingEntry) - 1]) {
							// Incoming sound isn't a duplicate of the previous sound
							$workingEntry[] = $soundTableEntry[$state];
						} else {
							// Incoming sound is a duplicate of the previous sound
							// For Hebrew and Arabic, we need to create a pair of D-M sound codes,
							// one of the pair with only a single occurrence of the duplicate sound,
							// the other with both occurrences
							if ($noVowels) {
								$workingEntry[] = $soundTableEntry[$state];
							}
						}
						if (count($workingEntry) < 7) {
							$partialResult[] = $workingEntry;
						} else {
							// This is the 6th code in the sequence
							// We're looking for 7 entries because the first is '!' and doesn't count
							$tempResult = str_replace('!', '', implode('', $workingEntry));
							// Only return codes from recognisable sounds
							if ($tempResult) {
								$result[] = substr($tempResult . '000000', 0, 6);
							}
						}
					}
				}
				$state = $state + 3; // Advance to next triplet while keeping the same basic state
			}
		}

		// Zero-fill and copy all remaining partial results
		foreach ($partialResult as $workingEntry) {
			$tempResult = str_replace('!', '', implode('', $workingEntry));
			// Only return codes from recognisable sounds
			if ($tempResult) {
				$result[] = substr($tempResult . '000000', 0, 6);
			}
		}

		return $result;
	}
}
